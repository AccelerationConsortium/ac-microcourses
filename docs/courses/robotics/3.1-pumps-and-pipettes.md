# 1. Pumps and Pipettes

```{contents}
:depth: 3
```

## ðŸ”° Tutorial

In this module, you will develop software to:
1. manage a peristaltic pumpâ€™s operations using a microcontroller and motor driver
2. manipulate the linear actuator of the Digital Pipette

### Peristaltic Pump

First, you will manage a peristaltic pumpâ€™s operations using a microcontroller and motor driver. Consider purchasing the hardware and setting it up yourself to enhance the experience. Hardware is optional for the completion of this module.

#### Bill of Materials

- [MDD3A DC Motor Driver](https://www.cytron.io/p-3amp-4v-16v-dc-motor-driver-2-channels)
- [Raspberry Pi Pico WH](https://www.raspberrypi.com/products/raspberry-pi-pico/?variant=raspberry-pi-pico-wh)
- [USB-A to micro USB-B cable](https://www.digikey.ca/en/products/detail/stewart-connector/SC-2AMK003F/8544577)
- [Adafruit Terminal PiCowbell for Pico with Pre-Soldered Sockets](https://www.adafruit.com/product/5907)
- [12V Peristaltic Pump](https://www.adafruit.com/product/1150)  (alternative: [5V peristaltic pump](https://www.adafruit.com/product/3910), but requires sufficient 5V power supply | optional: [silicone tubing](https://www.adafruit.com/product/3659))
- [12V 3A power supply](https://www.digikey.ca/en/products/detail/xp-power/VEL36US120-US-JA/6220849) (alternative: [12V 1A version](https://www.digikey.ca/en/products/detail/xp-power/VEL12US120-US-JA/5726833))
- [Jack to bare wire](https://www.digikey.ca/en/products/detail/tensility-international-corp/10-02247/6412282)
- [Alligator clip to female jumper wire pack](https://www.adafruit.com/product/4304) (only 2 required)
- [M/F silicone jumper wires](https://www.adafruit.com/product/5837) (non-silicone also OK, only 4 required)
- [Mini flathead screwdriver set](https://www.amazon.ca/dp/B08QCT9NHY/) (one for DC Motor driver terminals and a smaller one for PiCowbell terminals)
- [OPTIONAL] [Plastic beakers](https://www.amazon.ca/Measuring-Graduated-Polypropylene-Laboratory-Experiments/dp/B083JC39W8)
- [OPTIONAL] [Blue food coloring](https://www.amazon.ca/Club-House-Food-Colour-Preparation/dp/B00HVVNFPI/)
<!-- - [OPTIONAL] [Glycerin](https://www.amazon.ca/NOW-Vegetable-Glycerine-Liquid-118ml/dp/B00PUX5SF4/) (low vapor pressure for longer-running setups, alternative: water) -->

#### Demo

âœ… Read the [MDD3A DC Motor Driver datasheet](https://docs.google.com/document/d/1ax3gSo0srTzoSr2bo8ETLym0OqrYjlk_JCZK4kxtfXg/edit?usp=sharing)

âœ… Read [PWM](https://en.wikipedia.org/wiki/Pulse-width_modulation)

âœ… Read [Control LED brightness with PWM](https://projects.raspberrypi.org/en/projects/getting-started-with-the-pico/7)

âœ… Read [machine.PWM](https://docs.micropython.org/en/latest/rp2/quickref.html#pwm-pulse-width-modulation)

Use your knowledge, the documentation above, and any relevant datasheets to set up the circuit to control the peristaltic pump. After setting up the hardware, run the following code on the microcontroller (ensure you select the appropriate PWM Pin):

```python
from machine import Pin, PWM
from time import sleep

pwm = PWM(Pin(0))

pwm.freq(1000)

pwm.duty_u16(16384)  # 25% duty cycle
sleep(5)  # 5 seconds

pwm.duty_u16(0)  # stop the motor
```

You should observe the peristaltic pump turn on for five seconds.

https://github.com/sparks-baird/self-driving-lab-demo/blob/main/src/public_mqtt_sdl_demo/scripts/pump.py

### Digital Pipette

Next, you will control the linear actuator of the "Digital Pipette" to carry out precise dispensing.

#### Bill of Materials

Based on https://github.com/ac-rad/digital-pipette

- [Actuonix L16-100-63-6-R](https://www.actuonix.com/l16-100-63-6-r)
- [Raspberry Pi Pico WH](https://www.raspberrypi.com/products/raspberry-pi-pico/?variant=raspberry-pi-pico-wh)
- [Adafruit Terminal PiCowbell for Pico with Pre-Soldered Sockets](https://www.adafruit.com/product/5907)
- [1705 Pcs Machine Screw Assortment Kit, M2 M3 M4 M5](https://www.amazon.ca/Machine-Assortment-Metric-Washers-Button/dp/B0C3926M1B/). Only the following are needed:
  - M3 10 mm screws (3)
  - M3 20 mm screw (1)
  - M3 nuts (4)
- [Shunt Regulator: Fine-Adjust LV, 1.50Î©, 15W](https://www.pololu.com/product/3778)
- [6V Step-Up Voltage Regulator U3V70F6](https://www.pololu.com/product/2892)
- [5V wall adapter](https://www.digikey.ca/en/products/detail/phihong-usa/PSAA05A-050QL6-R/6560437)
- [3D printed parts](https://github.com/ac-rad/digital-pipette/tree/main/design/stl) (if you don't want to print these yourself, STL files can be uploaded to [Shapeways](https://www.shapeways.com/), [Protolabs Network](https://www.hubs.com/), [Xometry](https://www.xometry.com/), or similar. You can use white PLA filament)
- [Electrical wire (3 feet, black)](https://www.digikey.ca/en/products/detail/cnc-tech/10981-18-1-2000-001-1-TD/17799168)
- [Electrical wire (3 feet, red)](https://www.digikey.ca/en/products/detail/cnc-tech/10981-18-1-2000-004-1-TD/17799190)
- [M/F silicone jumper wires](https://www.adafruit.com/product/5837) (non-silicone also OK, only 4 required)
- [Wire cutter/stripper combo](https://www.amazon.ca/Professional-crimping-Multi-Tool-Stripper-Multi-Function/dp/B073YG65N2)
- [Mini flathead screwdriver set](https://www.amazon.ca/dp/B08QCT9NHY/) (one for regulators and a smaller one for PiCowbell terminals)

#### Demo

âœ… Read [Digital pipette: open hardware for liquid transfer in self-driving laboratories](https://doi.org/10.1039/D3DD00115F)

âœ… Read the [Digital Pipette GitHub README](https://github.com/ac-rad/digital-pipette)

https://github.com/AccelerationConsortium/ac-training-lab/blob/main/src/ac_training_lab/picow/digital-pipette/scripts/digital_pipette_picow_basic.py

Run the following code on your microcontroller:

```python
import utime
from machine import PWM, Pin

# Setup PWM
pwm = PWM(Pin(0))  # Use the appropriate GPIO pin
pwm.freq(50)  # 50 Hz frequency


def set_position(pulse_ms):
    duty = int((pulse_ms / 20.0) * 65535)
    pwm.duty_u16(duty)


# Example to set the actuator to different positions
set_position(1.1)  # Almost full retraction
utime.sleep(5)
set_position(1.9)  # Almost full extension

pwm.deinit()  # Deinitialize PWM
```

### Stepper Motor

You will use a stepper motor driver to control the position of a stepper motor.

#### Bill of Materials
- [Tic500 Stepper Motor Driver](https://www.pololu.com/product/3134)
- [Raspberry Pi Pico WH](https://www.raspberrypi.com/products/raspberry-pi-pico/?variant=raspberry-pi-pico-wh)
- [Adafruit Terminal PiCowbell for Pico with Pre-Soldered Sockets](https://www.adafruit.com/product/5907)
- [Electrical wire (3 feet, black)](https://www.digikey.ca/en/products/detail/cnc-tech/10981-18-1-2000-001-1-TD/17799168)
- [Electrical wire (3 feet, red)](https://www.digikey.ca/en/products/detail/cnc-tech/10981-18-1-2000-004-1-TD/17799190)
- [Electrical wire (3 feet, white)](https://www.digikey.ca/en/products/detail/cnc-tech/10981-18-1-2000-002-1-TD/17799244)
- [NEMA 17 Stepper Motor](https://www.adafruit.com/product/324)
- [12V 3A power supply](https://www.digikey.ca/en/products/detail/xp-power/VEL36US120-US-JA/6220849) (alternative: [12V 1A version](https://www.digikey.ca/en/products/detail/xp-power/VEL12US120-US-JA/5726833))
- [Jack to bare wire](https://www.digikey.ca/en/products/detail/tensility-international-corp/10-02247/6412282)
- [Electrical wire (3 feet, white)](https://www.digikey.ca/en/products/detail/cnc-tech/10981-18-1-2000-002-1-TD/17799244)
- [Mini flathead screwdriver set](https://www.amazon.ca/dp/B08QCT9NHY/) (one for Tic500 and a smaller one for PiCowbell terminals)

#### Demo

âœ… Read specs for [Tic500 Stepper Motor Driver](https://www.pololu.com/product/3134)

âœ… Read [Example IÂ²C code for MicroPython](https://www.pololu.com/docs/0J71/12.10)

âœ… Read datasheet for [NEMA 17 Stepper Motor](https://www.adafruit.com/product/324)

âœ… Browse [ticlib GitHub repo](https://github.com/jphalip/ticlib)

Run the following on your microcontroller:

```python
from machine import I2C
from ticlib import TicI2C, MachineI2CBackend

i2c = I2C(1)  # ID of your I2C peripheral
address = 14  # Address of the Tic, that is its device number
backend = MachineI2CBackend(i2c, address)

tic = TicI2C(backend)

from src.ticlib import TicUSB
from time import sleep

tic = TicUSB()

tic.halt_and_set_position(0)
tic.energize()
tic.exit_safe_start()

positions = [500, 300, 800, 0]
for position in positions:
    tic.set_target_position(position)
    while tic.get_current_position() != tic.get_target_position():
        sleep(0.1)

tic.deenergize()
tic.enter_safe_start()
```

### Fan Control

#### Bill of Materials
- [Adafruit EMC2101 I2C PC Fan Controller and Temperature Sensor](https://www.adafruit.com/product/4808)
- [Raspberry Pi Pico WH](https://www.raspberrypi.com/products/raspberry-pi-pico/?variant=raspberry-pi-pico-wh)
- [Adafruit Terminal PiCowbell for Pico with Pre-Soldered Sockets](https://www.adafruit.com/product/5907)
- [Grove to Stemma-QT connector](https://www.digikey.ca/en/products/detail/adafruit-industries-llc/4528/11627737)
- [High-quality soldering iron](https://www.amazon.ca/dp/B077JDGY1J/) (alternative: [lower quality kit](https://www.amazon.ca/handskit-Soldering-Equipment-Adjustable-Temperature/dp/B01N46T138/))
- [Solder](https://www.amazon.ca/TOWOT-Electrical-Soldering-Content-Sn60-Pd40/dp/B09JBKSHCT/) (alternative: [1](https://www.amazon.ca/MG-Chemicals-Leaded-Solder-Diameter/dp/B004258YDE/), [2](https://www.amazon.ca/TOWOT-Electrical-Soldering-Content-Sn60-Pd40/dp/B0943TNYMS/))
- 4-pin fan

```{figure} ./images/fan-control-mwe.png
:scale: 50%

Minimal working example set up of fan control.
```

```{figure} ./images/fan-wiring.png
:scale: 50%

Rough electrical diagram of control board.
```

### Additional Resources
- [I2C specification](https://www.nxp.com/docs/en/user-guide/UM10204.pdf)

## ðŸš€ Quiz

::::{tab-set}
:sync-group: category

:::{tab-item} Sp/Su 2024
:sync: sp2024

[URL]
:::

::::


## ðŸ“„ Assignment

Create a script that allows you to set peristaltic pump power as a fraction and then perform a calibration to determine a power to flow rate conversion for the peristaltic pump.

âœ… See an example calibration procedure in [Peristaltic Pump Calibration](https://docs.google.com/spreadsheets/d/18t2_kxa8xe1a8FoVrQRKD_lHAqVDYKhnHKoxriJCWNc/edit?usp=sharing).

Create a script that allows you to set Digital Pipette actuator position as a fraction from 0 to 1 and then perform a calibration to determine a pulse length to volume ratio. Note also the calibration procedure from the manuscript linked above.

Create a script that allows you to make four 90 degree rotations each spaced by 5 seconds.

::::{tab-set}
:sync-group: category

:::{tab-item} Sp/Su 2024
:sync: sp2024

[URL]
:::

::::
