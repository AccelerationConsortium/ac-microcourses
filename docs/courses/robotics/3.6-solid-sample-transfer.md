
(3.6-orientation)=
# ðŸ§© 3.6 Solid Sample Transfer

```{contents}
:depth: 3
```

## ðŸ”° Tutorial

his module revolves around "transfer of solid samples", and completes complex automation tasks through ROS, AprilTags, multi-axis robots and workflow orchestration platform. The goal is to learn how to coordinate different modules (including robot control, visual recognition, and workflow management) to complete complex solid sample transfer processes, such as performing a grabbing task from one workstation to another for sample processing (such as screwing a bottle cap or dropping a liquid). This is a multi-step automation process involving the coordinated operation of multiple hardware devices and software platforms.

### Bill of Materials

- [MyCobot Pi - World's Smallest and Lightest Six-Axis Collaborative Robot](https://shop.elephantrobotics.com/en-ca/collections/mycobot-280/products/mycobot-pi-worlds-smallest-and-lightest-six-axis-collaborative-robot)  
  A compact and versatile six-axis robot suitable for performing precise sample transfer tasks.

- [Camera Flange 2.0](https://shop.elephantrobotics.com/en-ca/collections/camera-modules/products/camera-flange-2-0)  
  A camera module attachment for enhanced visual feedback during sample transfer operations.

- [Adaptive Gripper](https://shop.elephantrobotics.com/en-ca/collections/grippers/products/adaptive-gripper)  
  A flexible gripper designed for secure handling and transfer of solid samples during automated processes.

- [G-Shape Base 2.0](https://shop.elephantrobotics.com/en-ca/collections/fixed-bases/products/g-shape-base-2-0)  
  A stable base for mounting the MyCobot robot, ensuring precision during robotic movements and sample handling.

- [Prefect](https://www.prefect.io/)  
  A workflow orchestration tool to manage and coordinate asynchronous tasks during the sample transfer process.

- [AprilTags Python Library](https://pypi.org/project/apriltag/)  
  Used for spatial referencing and tracking of sample containers using AprilTags for accurate positioning.

- [ROS Noetic Ninjemys](http://wiki.ros.org/noetic/Installation) (for Ubuntu 20.04)  
  A robotic framework used for controlling the multi-axis robot during the sample transfer process.

- [ROS 2 Foxy Fitzroy](https://docs.ros.org/en/foxy/Installation.html) (for newer ROS 2 applications)  
  A newer ROS version that can be used for more advanced robotic control and integration with workflow orchestration.

- [Multi-Axis Robot](https://shop.elephantrobotics.com/en-ca/collections/mycobot-280/products/mycobot-pi-worlds-smallest-and-lightest-six-axis-collaborative-robot)  
  A robotic arm designed for executing precise sample movements across multiple axes.

- [TurtleBot3 Burger](https://emanual.robotis.com/docs/en/platform/turtlebot3/overview/)  
  An auxiliary robot for moving samples or collaborating with the multi-axis robot in complex workflows.

- [Raspberry Pi 4 Model B](https://www.raspberrypi.org/products/raspberry-pi-4-model-b/)  
  A microcontroller for running ROS and interfacing with the multi-axis robot and peripheral devices.

- USB-A to micro USB-B cable:  
  For connecting the Raspberry Pi and other peripheral devices for power and data transfer.

- SD Card with Raspbian OS: 
  Pre-installed with Raspbian OS for quick setup of the Raspberry Pi during integration with the robot.

#### Documentation

- [MyCobot Pi Documentation](https://docs.elephantrobotics.com/docs/gitbook-en/2-serialproduct/2.1-280/2.1.2-PI.html)  
  A guide for setting up and controlling the MyCobot robot for sample transfer tasks.

- [Gripper Control via Python](https://docs.elephantrobotics.com/docs/gitbook-en/7-ApplicationBasePython/7.5_gripper.html)  
  Detailed instructions for using Python to control the adaptive gripper during the sample transfer process.

- [TurtleBot3 Documentation](https://emanual.robotis.com/docs/en/platform/turtlebot3/overview/)  
  Official documentation for using the TurtleBot3 in conjunction with the multi-axis robot for automated workflows.

### Notes
These materials enable the setup and execution of a solid sample transfer process, utilizing ROS, AprilTags, and a multi-axis robot for precision control. Prefect orchestrates the workflow, allowing for asynchronous task management in a highly automated and efficient manner. This setup is ideal for educational and research environments that require robust and flexible sample handling solutions.

### Demo
### Multi-Axis Robotics

A multi-axis robot, such as a 6-axis robotic arm, can perform complex movements for handling solid samples with precision. Using **ROS** and integrating workflow orchestration via **Prefect** ensures that the robot's movements are coordinated efficiently with the detected **AprilTags**.

#### Demo

âœ… Watch [What is a 6-Axis Robot?](https://www.youtube.com/watch?v=UxO0xqvvGcM&pp=ygUcNi1BeGlzIFJvYm90aWMgQXJtIGluIEFjdGlvbg%3D%3D)

You can control the robotic arm using **ROS** commands:

```bash
# Command the multi-axis robot to move to a specific position
rosrun robot_movement_interface move_robot_to_position.py --x 10 --y 20 --z 30
```

The **multi-axis robot** can then follow the precise coordinates based on **AprilTag** detection and transfer solid samples between different positions.

---


### Analysis of each module and its combination:

1. ROS (Robot Operating System):
- Introduction to ROS: ROS is an open source framework for robot development and control, suitable for managing complex robot operations, especially multi-axis robots. In the solid sample transfer scenario, ROS is used to control multi-axis robots to complete precise sample grabbing, movement, and manipulation.
- Application scenario: ROS is responsible for controlling the multi-axis robot to grab samples from workstation A and transfer them to workstation B. At the same time, ROS can obtain real-time feedback by connecting different sensors (such as cameras and force sensors) to ensure the accuracy of the operation.
- How to combine with other modules:
- Integration with AprilTags: ROS is integrated with AprilTags to identify the position and orientation of the sample or target workstation, providing the robot with accurate coordinates for grabbing and placing.
- Integrate with workflow orchestration platform: ROS is responsible for low-level robot control, while task scheduling and sequence management are handled by workflow orchestration platforms (such as Prefect).

2. AprilTags (Tag Identification):
- About AprilTags: AprilTags is a two-dimensional label system, similar to QR code, commonly used for position and posture estimation in robot vision. In this scenario, AprilTags can be attached to samples, containers or workstations to help robots accurately locate and operate.
- Application scenario: The multi-axis robot needs to identify the AprilTags on the sample through a visual system (such as a camera) to determine the specific position and posture of the sample to ensure accurate grasping and operation.
- How to combine with other modules:
- Integration with ROS: By publishing the detection results of AprilTags through ROS, the robot can adjust its grasping posture and position in real time. For example, after detecting the AprilTags of a sample or container, ROS can adjust the operation of the robot arm based on the visual input.
- Combined with multi-axis robots: AprilTags provide precise sample location information, ensuring that multi-axis robots can accurately grasp and place samples in complex environments.

3. Multi-axis robot:
- Introduction to multi-axis robots: Multi-axis robots have multiple degrees of freedom and can perform complex operations in three-dimensional space, such as grasping, rotating, unscrewing bottle caps, pouring samples, etc. In this scenario, the robot needs to complete a complete set of operations from grasping samples, moving samples, to accurately placing samples.
- Application scenarios: Multi-axis robots use ROS instructions to complete complex sample transfer tasks, such as grabbing solid samples, unscrewing or tightening bottle caps, and accurately placing samples at the target location.
- How to combine with other modules:
- Integration with ROS: Through commands issued by ROS, the multi-axis robot can perform various movements, including linear movement, rotation, grasping, etc.
- Combined with AprilTags: The robot detects AprilTags to determine the location of the sample or workstation and perform accurate operations.

4. Workflow orchestration platform (such as Prefect):
- Introduction to Workflow Orchestration: Workflow orchestration platforms (such as Prefect) can be used to manage and schedule complex asynchronous tasks, ensure that the various steps of robot operations are executed in sequence, and handle concurrent tasks that may arise.
- Application scenario: During the entire process of solid sample transfer, the workflow orchestration platform is responsible for managing the execution order of each step. For example, the steps of a task include: 1) detecting the sample position, 2) grabbing the sample, 3) transferring the sample to the next workstation, 4) completing the specified operation (such as unscrewing the bottle cap), and 5) putting the sample back in place.
- How to combine with other modules:
- Integration with ROS: ROS is responsible for executing specific robot control commands, while the workflow orchestration platform is responsible for determining the order and dependencies of tasks to ensure that each task is triggered at the right time.
- Integrated with AprilTags: In the task process, the workflow orchestration platform can trigger subsequent tasks based on the detection results of AprilTags (such as identifying the sample location).

### Task combination and process

#### Application scenario: Solid sample transfer process

Suppose the robot needs to complete the following tasks:
1. Grab solid sample: The robot grabs the sample from workstation A.
2. Detect the AprilTag of the sample: The robot uses the camera to identify the AprilTag on the sample and determine its position and posture.
3. Move sample: The robot transfers the sample to workstation B.
4. Perform sample operations: For example, the robot unscrews the sample bottle cap at workstation B and adds liquid quantitatively.
5. Place sample: The robot puts the sample back to its original position.

#### Code examples and flow:

##### Steps 1 & 2: Grab samples and detect AprilTag

```Python
import rospy
from geometry_msgs.msg import Twist
from apriltag_ros.msg import AprilTagDetectionArray

def tag_callback(data):
for detection in data.detections:
rospy.loginfo(f"Detected AprilTag ID: {detection.id}")

def move_robot_to_grab():
pub = rospy.Publisher('/cmd_vel', Twist, queue_size=10)
rospy.init_node('robot_controller')
    
twist = Twist()
twist.linear.x = 0.2 # Move forward
pub.publish(twist)
rospy.sleep(3) # Move for 3 seconds
    
rospy.Subscriber('/tag_detections', AprilTagDetectionArray, tag_callback)
    
rospy.spin()

if __name__ == "__main__":
move_robot_to_grab()
```

- Explanation: The robot moves to the sample location through ROS and detects the sample through AprilTags. Use `AprilTagDetectionArray` to identify the sample and get its ID and location.

##### Step 3: Move samples to workstation B

```Python
def move_robot_to_workstation_b():
pub = rospy.Publisher('/cmd_vel', Twist, queue_size=10)
    
twist = Twist()
twist.linear.x = 0.3 # Move forward to station B
twist.angular.z = 0.2 # Rotate to adjust the angle
pub.publish(twist)
rospy.sleep(5) # Move and adjust posture
    
rospy.loginfo("The sample has been moved to workstation B")

if __name__ == "__main__":
move_robot_to_workstation_b()
```

##### Step 4: Complete the specified operation (such as unscrewing the bottle cap)

```Python
def perform_sample_operation():
rospy.loginfo("Start executing sample operation: unscrew the bottle cap")
# Add the robot control code here, such as grabbing samples and rotating the bottle cap
# Joint angle control can be used, such as the joint angle information of the robot arm
    
rospy.sleep(2) # simulate bottle cap operation time
rospy.loginfo("Operation completed")

if __name__ == "__main__":
perform_sample_operation()
```

##### Step 5: Put the sample back in place

```Python
def place_sample_back():
rospy.loginfo("Put the sample back in place")
# Continue issuing control commands through the robotic arm
rospy.sleep(2)
rospy.loginfo("Sample placement completed")

if __name__ == "__main__":
place_sample_back()
```

---

### Workflow Orchestration Integration

Finally, we use Prefect to orchestrate the entire process and ensure that tasks are executed in order.

```Python
from prefect import task, Flow

@task
def grab_sample():
move_robot_to_grab()

@task
def move_to_workstation_b():
move_robot_to_workstation_b()

@task
def sample_operation():
perform_sample_operation()

@task
def place_sample():
place_sample_back()

with Flow("Solid Sample Transfer Workflow") as flow:
grab_sample()
move_to_workstation_b()
sample_operation()
place_sample()

# Execute workflow
flow.run()
```

Summary of the process:
1. Grab samples: Control the robot to move and identify samples through ROS.
2. Move to workstation B: Use AprilTags to perform position calibration and move the sample to the target workstation.
3. Perform sample operations: Perform operations such as unscrewing bottle caps at workstation B.
4. Place sample: After the task is completed, the robot puts the sample back to its original position.



## ðŸš€ Quiz

::::{tab-set}
:sync-group: category

:::{tab-item} Sp/Su 2024
:sync: sp2024

[Quiz URL]
:::

::::

---

## ðŸ“„ Assignment

Create a script that uses **ROS**, **AprilTags**, and a multi-axis robot to perform a solid sample transfer. Your task is to:
1. **Use ROS** to move the multi-axis robot to specific positions.
2. **Detect solid samples** using **AprilTags**.
3. **Orchestrate the workflow** using **Prefect** to manage the robot's tasks, such as moving to the sample, picking it up, and transferring it to a new location.

Example tasks:
1. Write a script to detect **AprilTags** and use their coordinates to instruct the robot's movement.
2. Create a workflow using **Prefect** to automate sample transfer from one location to another.
3. Test your system with a solid sample and verify its accuracy.


